record(waveform, "$(P)VOLT:CALC")
{
    field(SCAN, "Passive")
    field(NELM, "1000")
    field(FTVL, "DOUBLE")
}

record(waveform, "$(P)CURR:CALC")
{
    field(SCAN, "Passive")
    field(NELM, "1000")
    field(FTVL, "DOUBLE")
}


record(ai, "$(P)SAMPLETIME")
{

    field(SCAN, "Passive")
    field(VAL, "1.0")
    field(FTVL, "DOUBLE")
}

record(ai, "$(P)VOLT:UPPERLIM")
{

    field(SCAN, "Passive")
    field(VAL, "6.0")
    field(FTVL, "DOUBLE")
}

record(ai, "$(P)VOLT:LOWERLIM")
{

    field(SCAN, "Passive")
    field(VAL, "4.0")
    field(FTVL, "DOUBLE")
}

record(ai, "$(P)CURR:STEADY")
{
    field(SCAN, "Passive")
    field(VAL, "1.0")
    field(FTVL, "DOUBLE")
}

record(ai, "$(P)CURR:LIMIT")
{
    field(SCAN, "Passive")
    field(VAL, "0.5")
    field(FTVL, "DOUBLE")
}

record(acalcout, "$(P)_STABILITYCHECK")
{
    field(DESC, "Finds number of samples outside limits")
    field(OOPT, "Every Time")
    #field(FLNK, "$(P)STABILITY PP")
    field(NELM, "1000")
	
	
    # 0 if sample is within threshold, 1 if sample is outside threshold
    # A is upper limit, B is lower limit, C + D is current threshold
    field(CALC, "SUM((A<AA)||(B>AA)||((C+D)<=BB))")

	# This will update on new voltage and current data. This may need revisiting to only update once.
    field(INAA, "$(P)VOLT:CALC CP")
    field(INBB, "$(P)CURR:CALC NPP")
	
    field(INPA, "$(P)VOLT:UPPERLIM NPP")
    field(INPB, "$(P)VOLT:LOWERLIM NPP")
    field(INPC, "$(P)CURR:STEADY NPP")
    field(INPD, "$(P)CURR:LIMIT NPP")

    field(FLNK, "$(P)_SAMPLEBUFFER PP")
}

record(compress, "$(P)_SAMPLEBUFFER")
{
    #field(DESC, "1 second stability data buffer")
    field(SCAN, "Passive")
    field(ALG, "Circular Buffer")
    field(NSAM, "1000")

    #field(FLNK, "$(P)_TOTALSAMPLES PP")

    field(INP, "$(P)_STABILITYCHECK NPP")
}


record(acalcout, "$(P)_TOTALSAMPLES")
{
    field(DESC, "Counts unstable time")
    field(SCAN, "Passive")
    field(OOPT, "Every Time")

    field(NELM, "1000")

    field(CALC, "SUM(AA)")

    field(INAA, "$(P)_SAMPLEBUFFER NPP")
}

record(ao, "$(P)_ZEROCOUNTER")
{
    field(SCAN, "Passive")
    field(VAL, "1")
    field(OUT, "$(P)_SAMPLEBUFFER.RES")
}

record(compress, "$(P)_MOVINGBUFFER")
{
    field(DESC, "Records stability over time")
    field(SCAN, "Passive")
    field(ALG, "Circular Buffer")
    field(NSAM, "600")
    field(INP, "$(P)_TOTALSAMPLES NPP")
}

record(fanout, "$(P)_COUNTERTIMING")
{
    field(SCAN, "1 second")
#    field(LNK1, "$(P)_SAMPLEBUFFER PP")
    field(LNK1, "$(P)_MOVINGBUFFER PP")
    #field(LNK2, "$(P)_ZEROCOUNTER PP")
    field(LNK3, "$(P)STABILITY PP")
}

record(acalcout, "$(P)STABILITY")
{
    field(DESC, "Calculates instability moving window")
    field(SCAN, "Passive")
	
	field(CALC, "SUM(AA)*B")
	
    field(INPA, "$(P)_MOVINGBUFFER NPP ")
	field(INPB, "$(P)SAMPLETIME NPP")
}
